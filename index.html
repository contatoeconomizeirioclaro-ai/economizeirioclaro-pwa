<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Economizei Rio Claro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f4c430">

  <!-- Splash -->
  <link rel="stylesheet" href="/splash.css">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff;
    }

    iframe {
      border: none;
      width: 100%;
      height: 100%;
      display: none;
      visibility: hidden;
      opacity: 0;
      transition: opacity .3s ease;
    }

    body.splash-complete iframe {
      display: block;
      visibility: visible;
      opacity: 1;
    }

    body:not(.splash-complete) > iframe {
      display: none !important;
    }
  </style>
</head>

<body>

<!-- SPLASH (somente app instalado) -->
<div id="splash-screen">
  <div class="splash-container">
    <img id="splash-pin"
      src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png"
      width="200" height="200" alt="Economizei">

    <img id="splash-text"
      src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/logo-texto.png"
      width="250" height="90" alt="Economizei Rio Claro">
  </div>
</div>

<!-- BLOGGER -->
<iframe
  src="https://www.economizeirioclaro.com.br/?app=1"
  loading="eager"
  referrerpolicy="no-referrer-when-downgrade"
  allow="fullscreen">
</iframe>

<script>
/* =====================================================
   ECONOMIZEI — PASSO 1
   NOTIFICAÇÕES INTERNAS (GOOGLE SHEETS)
   ===================================================== */

document.addEventListener('DOMContentLoaded', () => {

  const SHEETS_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQgRkzdvRw_Qjb_tMexnc49QXEAo4wdBAzA9spA_7PVQReYlH15GaVCTTjIBllU2IKZS0LEr-SBKk7b/pub?output=csv';

  // Registrar Service Worker (offline + notificações locais)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(() => console.log('✅ SW registrado'))
      .catch(err => console.error('❌ SW erro', err));
  }

  // Evitar múltiplas verificações no mesmo dia
  const hoje = new Date().toISOString().split('T')[0];
  if (localStorage.getItem('sheets-last-check') === hoje) return;

  setTimeout(verificarSheets, 3000);

  async function verificarSheets() {
    try {
      const res = await fetch(SHEETS_URL + '&t=' + Date.now());
      const csv = await res.text();
      const mensagens = csvToJson(csv);

      const vistas = JSON.parse(
        localStorage.getItem('sheets-vistas') || '[]'
      );

      const novas = mensagens.filter(m =>
        !vistas.includes(String(m.id))
      );

      if (!novas.length) {
        localStorage.setItem('sheets-last-check', hoje);
        return;
      }

      novas
        .sort((a,b) => prioridade(b.prioridade) - prioridade(a.prioridade))
        .forEach((msg, i) => {
          setTimeout(() => notificar(msg), i * 3000);
        });

      const ids = novas.map(n => String(n.id));
      localStorage.setItem(
        'sheets-vistas',
        JSON.stringify([...vistas, ...ids].slice(-50))
      );

      localStorage.setItem('sheets-last-check', hoje);

    } catch (e) {
      console.error('❌ Sheets erro', e);
    }
  }

  function notificar(msg) {
    if (!('serviceWorker' in navigator)) return;

    navigator.serviceWorker.ready.then(reg => {
      reg.active?.postMessage({
        type: 'SHOW_NOTIFICATION',
        title: msg.titulo,
        body: msg.mensagem,
        url: msg.url,
        id: msg.id
      });
    });
  }

  function prioridade(p) {
    return { alta: 3, media: 2, baixa: 1 }[p] || 1;
  }

  function csvToJson(csv) {
    const linhas = csv.split('\n').filter(l => l.trim());
    const out = [];

    for (let i = 1; i < linhas.length; i++) {
      const c = linhas[i].split(',');
      if (c.length < 6) continue;

      out.push({
        id: c[0],
        titulo: c[1],
        mensagem: c[2],
        data: c[3],
        url: c[4],
        prioridade: c[5]?.toLowerCase()
      });
    }
    return out;
  }

});
</script>

<script src="/splash.js"></script>
</body>
</html>

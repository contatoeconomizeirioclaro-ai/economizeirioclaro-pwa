<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Economizei Rio Claro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f4c430">
  
  <!-- CSS da Splash Screen Refinada -->
  <link rel="stylesheet" href="/splash.css">

  <style>
    /* Estilos principais do wrapper */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff;
    }
    
    /* Iframe - escondido inicialmente */
    iframe {
      border: none;
      width: 100%;
      height: 100%;
      display: none; /* Escondido at√© splash terminar */
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    /* Quando splash terminar, mostrar iframe */
    body.splash-complete iframe {
      display: block;
      visibility: visible;
      opacity: 1;
    }
    
    /* Estado inicial - garantir que tudo esteja escondido */
    body:not(.splash-complete) > iframe {
      display: none !important;
    }
    
    /* Bot√£o de Notifica√ß√µes (estilo) */
    #push-notification-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #f4c430;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(244, 196, 48, 0.3);
      transition: all 0.3s;
      font-size: 14px;
    }
    
    #push-notification-btn:hover {
      background: #e0b429;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(244, 196, 48, 0.4);
    }
    
    #push-notification-btn:active {
      transform: translateY(0);
    }
    
    /* Bot√£o para Google Sheets Notifications */
    #sheets-notification-btn {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: #0F9D58;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      z-index: 10000;
      display: none;
    }
  </style>
</head>
<body>

  <!-- Splash Screen Refinada -->
  <!-- Aparece apenas no app instalado -->
  <div id="splash-screen">
    <div class="splash-container">
      <!-- PIN aumentado para 150px -->
      <img id="splash-pin" 
           src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png" 
           alt="√çcone Economizei"
           width="200"
           height="200">
      
      <!-- TEXTO mantido 250px -->
      <!-- Espa√ßo de 5px entre pin e texto -->
      <img id="splash-text" 
           src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/logo-texto.png" 
           alt="Economizei Rio Claro"
           width="250"
           height="90">
    </div>
  </div>

  <!-- Seu site Blogger no iframe -->
  <iframe
    src="https://www.economizeirioclaro.com.br/?app=1"
    loading="eager"
    referrerpolicy="no-referrer-when-downgrade"
    allow="fullscreen"
    title="Economizei Rio Claro - Ofertas e Promo√ß√µes">
  </iframe>

  <script>
  // ============================================
  // SISTEMA DE NOTIFICA√á√ïES ECONOMIZEI - VERS√ÉO GOOGLE SHEETS
  // ============================================

  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Economizei - Inicializando Google Sheets System...');
    
    // ============================================
    // CONFIGURA√á√ïES DO SISTEMA
    // ============================================
    
    // CONFIG: Sistema de push notifications (desativado)
    const USE_PUSH_NOTIFICATIONS = false;
    
    // CONFIG: Sistema de notifica√ß√µes via Google Sheets (ATIVADO)
    const GOOGLE_SHEETS_NOTIFICATIONS = true;
    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQgRkzdvRw_Qjb_tMexnc49QXEAo4wdBAzA9spA_7PVQReYlH15GaVCTTjIBllU2IKZS0LEr-SBKk7b/pub?output=csv';
    
    // ============================================
    // REGISTRO DO SERVICE WORKER
    // ============================================
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('‚úÖ Service Worker registrado: /sw.js');
          
          // Inicializar sistema Google Sheets
          if (GOOGLE_SHEETS_NOTIFICATIONS) {
            initGoogleSheetsNotificationSystem(registration);
          }
          
          // Inicializar push apenas se configurado
          if (USE_PUSH_NOTIFICATIONS) {
            initPushNotificationSystem(registration);
          }
        })
        .catch(error => {
          console.error('‚ùå Falha no Service Worker:', error);
          // Tentar Google Sheets mesmo sem SW
          if (GOOGLE_SHEETS_NOTIFICATIONS) {
            initGoogleSheetsNotificationSystem();
          }
        });
    } else {
      console.log('‚ö†Ô∏è Navegador n√£o suporta Service Worker');
      if (GOOGLE_SHEETS_NOTIFICATIONS) {
        initGoogleSheetsNotificationSystem();
      }
    }
    
    // Verificar se est√° rodando como app instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('üì± Economizei rodando como app instalado');
      document.documentElement.setAttribute('data-app-mode', 'installed');
    }
    
    // ============================================
    // SISTEMA DE NOTIFICA√á√ïES VIA GOOGLE SHEETS
    // ============================================
    
    function initGoogleSheetsNotificationSystem(registration = null) {
      console.log('üìä Inicializando sistema Google Sheets Notifications...');
      
      // Verificar se j√° verificou hoje
      const ultimaVerificacao = localStorage.getItem('sheets-last-check');
      const hoje = new Date().toISOString().split('T')[0];
      
      if (ultimaVerificacao === hoje) {
        console.log('üìÖ J√° verificou notifica√ß√µes hoje');
        return;
      }
      
      // Esperar 3 segundos ap√≥s carregamento
      setTimeout(async () => {
        try {
          await verificarNotificacoesGoogleSheets(registration);
        } catch (erro) {
          console.error('‚ùå Erro no sistema Google Sheets:', erro);
        }
      }, 3000);
    }
    
    async function verificarNotificacoesGoogleSheets(registration) {
      console.log('üîç Verificando notifica√ß√µes no Google Sheets...');
      
      try {
        // Buscar CSV do Google Sheets (com cache busting)
        const resposta = await fetch(`${GOOGLE_SHEETS_URL}&t=${Date.now()}`);
        
        if (!resposta.ok) throw new Error(`HTTP ${resposta.status}`);
        
        const csvTexto = await resposta.text();
        
        // Converter CSV para JSON
        const mensagens = converterCSVparaJSON(csvTexto);
        
        console.log(`üì¶ ${mensagens.length} mensagem(ns) encontrada(s)`, mensagens);
        
        if (mensagens.length === 0) {
          console.log('üì≠ Nenhuma mensagem na planilha');
          localStorage.setItem('sheets-last-check', new Date().toISOString().split('T')[0]);
          return;
        }
        
        // Mensagens j√° vistas
        const mensagensVistas = JSON.parse(
          localStorage.getItem('sheets-mensagens-vistas') || '[]'
        );
        
        // Filtrar mensagens N√ÉO vistas
        const novasMensagens = mensagens.filter(msg => 
          !mensagensVistas.includes(msg.id.toString())
        );
        
        console.log(`üÜï ${novasMensagens.length} nova(s) mensagem(ns)`);
        
        if (novasMensagens.length > 0) {
          // Ordenar por prioridade
          const novasOrdenadas = ordenarPorPrioridade(novasMensagens);
          
          // Mostrar notifica√ß√µes
          mostrarNotificacoesEmSequencia(novasOrdenadas, registration);
          
          // Salvar como vistas
          salvarMensagensVistas(novasOrdenadas, mensagensVistas);
        }
        
        // Atualizar √∫ltima verifica√ß√£o
        localStorage.setItem('sheets-last-check', new Date().toISOString().split('T')[0]);
        
      } catch (erro) {
        console.error('‚ùå Erro ao verificar Google Sheets:', erro);
        // Tentar novamente em 1 hora
        setTimeout(() => {
          if (GOOGLE_SHEETS_NOTIFICATIONS) {
            verificarNotificacoesGoogleSheets(registration);
          }
        }, 3600000);
      }
    }
    
    function converterCSVparaJSON(csv) {
      try {
        const linhas = csv.split('\n').filter(linha => linha.trim() !== '');
        const resultado = [];
        
        if (linhas.length < 2) return resultado; // Precisa ter cabe√ßalho + dados
        
        // Pular cabe√ßalho (primeira linha) e processar dados
        for (let i = 1; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          if (!linha) continue;
          
          // Divis√£o inteligente de CSV (respeita v√≠rgulas dentro de aspas)
          const valores = [];
          let dentroDeAspas = false;
          let valorAtual = '';
          
          for (let char of linha) {
            if (char === '"') {
              dentroDeAspas = !dentroDeAspas;
            } else if (char === ',' && !dentroDeAspas) {
              valores.push(valorAtual.trim());
              valorAtual = '';
            } else {
              valorAtual += char;
            }
          }
          valores.push(valorAtual.trim()); // √öltimo valor
          
          // Limpar aspas dos valores
          const valoresLimpos = valores.map(v => v.replace(/^"|"$/g, ''));
          
          if (valoresLimpos.length >= 6) {
            resultado.push({
              id: parseInt(valoresLimpos[0]) || i,
              titulo: valoresLimpos[1] || 'üì± Economizei',
              mensagem: valoresLimpos[2] || 'Nova oferta dispon√≠vel',
              data: valoresLimpos[3] || new Date().toISOString().split('T')[0],
              url: valoresLimpos[4] || 'https://www.economizeirioclaro.com.br',
              prioridade: valoresLimpos[5]?.toLowerCase() || 'media'
            });
          }
        }
        
        return resultado;
      } catch (error) {
        console.error('‚ùå Erro ao converter CSV:', error);
        return [];
      }
    }
    
    function ordenarPorPrioridade(mensagens) {
      const prioridades = { alta: 3, media: 2, baixa: 1 };
      return [...mensagens].sort((a, b) => {
        return (prioridades[b.prioridade] || 1) - (prioridades[a.prioridade] || 1);
      });
    }
    
    function mostrarNotificacoesEmSequencia(mensagens, registration) {
      let delay = 0;
      
      mensagens.forEach((msg) => {
        setTimeout(() => {
          mostrarNotificacaoLocal(msg, registration);
        }, delay);
        
        delay += 3000; // 3 segundos entre notifica√ß√µes
      });
    }
    
    function mostrarNotificacaoLocal(mensagem, registration) {
      if (!('Notification' in window)) {
        console.log('‚ö†Ô∏è Navegador n√£o suporta notifica√ß√µes');
        return;
      }
      
      // M√©todo PREFERIDO: enviar mensagem para Service Worker
      if (registration && registration.active) {
        registration.active.postMessage({
          type: 'SHOW_NOTIFICATION',
          title: mensagem.titulo || 'üì± Economizei',
          body: mensagem.mensagem || 'Nova oferta dispon√≠vel!',
          icon: 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png',
          url: mensagem.url || 'https://www.economizeirioclaro.com.br',
          id: mensagem.id
        });
        console.log('üì® Mensagem enviada para SW');
        return;
      }
      
      // Fallback: notifica√ß√£o direta do navegador
      if (Notification.permission === 'granted') {
        mostrarNotificacaoFallback(mensagem);
      } else if (Notification.permission === 'default') {
        // Solicitar permiss√£o silenciosamente
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            mostrarNotificacaoFallback(mensagem);
          }
        });
      }
    }
    
    function mostrarNotificacaoFallback(mensagem) {
      try {
        const notificacao = new Notification(
          mensagem.titulo || 'üì± Economizei', 
          {
            body: mensagem.mensagem || 'Nova oferta dispon√≠vel!',
            icon: 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png',
            data: {
              url: mensagem.url || 'https://www.economizeirioclaro.com.br',
              id: mensagem.id
            }
          }
        );
        
        notificacao.onclick = () => {
          window.open(mensagem.url || 'https://www.economizeirioclaro.com.br', '_blank');
          notificacao.close();
        };
      } catch (err) {
        console.error('‚ùå Erro ao criar notifica√ß√£o:', err);
      }
    }
    
    function salvarMensagensVistas(novasMensagens, mensagensVistasAnteriores) {
      const novosIds = novasMensagens.map(msg => msg.id.toString());
      const todasVistas = [...mensagensVistasAnteriores, ...novosIds];
      
      // Manter apenas √∫ltimas 50 mensagens
      const limitadas = todasVistas.slice(-50);
      localStorage.setItem('sheets-mensagens-vistas', JSON.stringify(limitadas));
    }
    
    // ============================================
    // SISTEMA DE PUSH NOTIFICATIONS (OPCIONAL)
    // ============================================
    
    function initPushNotificationSystem(registration) {
      console.log('üîî Inicializando sistema de push notifications...');
      
      // Criar bot√£o de ativa√ß√£o
      const notificationBtn = document.createElement('button');
      notificationBtn.id = 'push-notification-btn';
      notificationBtn.innerHTML = 'üîî Ativar Notifica√ß√µes Push';
      
      // Estado inicial
      const isAlreadyEnabled = localStorage.getItem('economizei-push-enabled') === 'true';
      const permissionStatus = Notification.permission;
      
      // Mostrar bot√£o apenas se necess√°rio
      if (!isAlreadyEnabled && permissionStatus === 'default') {
        notificationBtn.style.display = 'block';
      } else {
        notificationBtn.style.display = 'none';
      }
      
      // Evento de clique no bot√£o
      notificationBtn.addEventListener('click', async function() {
        console.log('üñ±Ô∏è Bot√£o de push clicado');
        
        try {
          notificationBtn.innerHTML = '‚è≥ Solicitando permiss√£o...';
          notificationBtn.disabled = true;
          
          const permission = await Notification.requestPermission();
          
          if (permission === 'granted') {
            try {
              // Chave p√∫blica VAPID de teste
              const vapidPublicKey = 'BKYvJLwQ9gQcKJvK7vL8cT7HJkLp09gFcVbN7mKjL9hTqW8zXcVbN7mKjL9hTqW8zXc';
              
              const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
              });
              
              localStorage.setItem('economizei-push-enabled', 'true');
              localStorage.setItem('economizei-push-subscription', JSON.stringify(subscription));
              
              notificationBtn.innerHTML = '‚úÖ Push Ativadas!';
              notificationBtn.style.background = '#4CAF50';
              
              setTimeout(() => {
                notificationBtn.style.display = 'none';
              }, 2000);
              
            } catch (subscribeError) {
              console.error('‚ùå Erro na inscri√ß√£o push:', subscribeError);
              
              localStorage.setItem('economizei-push-enabled', 'true');
              notificationBtn.innerHTML = '‚úÖ Notifica√ß√µes Locais';
              notificationBtn.style.background = '#4CAF50';
              
              setTimeout(() => {
                notificationBtn.style.display = 'none';
              }, 2000);
            }
            
          } else if (permission === 'denied') {
            notificationBtn.innerHTML = '‚ùå Permiss√£o Negada';
            notificationBtn.style.background = '#f44336';
            
            setTimeout(() => {
              notificationBtn.innerHTML = 'üîî Ativar Push';
              notificationBtn.style.background = '#f4c430';
              notificationBtn.disabled = false;
            }, 3000);
            
          } else {
            notificationBtn.innerHTML = 'üîî Ativar Push';
            notificationBtn.disabled = false;
          }
          
        } catch (error) {
          console.error('üí• Erro no processo de ativa√ß√£o:', error);
          
          notificationBtn.innerHTML = '‚ùå Erro - Tente Novamente';
          notificationBtn.style.background = '#f44336';
          
          setTimeout(() => {
            notificationBtn.innerHTML = 'üîî Ativar Push';
            notificationBtn.style.background = '#f4c430';
            notificationBtn.disabled = false;
          }, 3000);
        }
      });
      
      // Adicionar bot√£o ao body
      document.body.appendChild(notificationBtn);
      
      // Fun√ß√£o auxiliar para converter chave VAPID
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');
        
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }
    }
    
    // ============================================
    // TESTE E DEBUG (apenas em desenvolvimento)
    // ============================================
    
    // Adicionar bot√£o de teste se estiver em desenvolvimento
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
      const testBtn = document.createElement('button');
      testBtn.innerHTML = 'üîß Testar Notifica√ß√£o';
      testBtn.style.cssText = `
        position: fixed;
        bottom: 70px;
        left: 20px;
        background: #9C27B0;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10000;
      `;
      
      testBtn.addEventListener('click', () => {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.ready.then(reg => {
            reg.showNotification('üì± Economizei - Teste', {
              body: 'Teste do sistema Google Sheets!',
              icon: 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png',
              data: {
                url: 'https://www.economizeirioclaro.com.br',
                test: true
              }
            });
          });
        }
      });
      
      document.body.appendChild(testBtn);
      
      // Bot√£o para limpar cache
      const clearBtn = document.createElement('button');
      clearBtn.innerHTML = 'üóëÔ∏è Limpar Cache';
      clearBtn.style.cssText = `
        position: fixed;
        bottom: 110px;
        left: 20px;
        background: #FF9800;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10000;
      `;
      
      clearBtn.addEventListener('click', () => {
        localStorage.removeItem('sheets-last-check');
        localStorage.removeItem('sheets-mensagens-vistas');
        console.log('‚úÖ Cache Google Sheets limpo! Recarregue a p√°gina.');
        alert('Cache limpo. Recarregue a p√°gina para testar.');
      });
      
      document.body.appendChild(clearBtn);
      
      // Bot√£o para testar Google Sheets diretamente
      const sheetsBtn = document.createElement('button');
      sheetsBtn.innerHTML = 'üìä Testar Sheets';
      sheetsBtn.style.cssText = `
        position: fixed;
        bottom: 150px;
        left: 20px;
        background: #0F9D58;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10000;
      `;
      
      sheetsBtn.addEventListener('click', () => {
        console.log('üß™ Testando conex√£o Google Sheets...');
        fetch(GOOGLE_SHEETS_URL)
          .then(r => r.text())
          .then(csv => {
            const mensagens = converterCSVparaJSON(csv);
            console.log('‚úÖ Google Sheets OK:', mensagens);
            alert('Google Sheets OK! ' + mensagens.length + ' mensagens');
          })
          .catch(err => {
            console.error('‚ùå Google Sheets erro:', err);
            alert('Erro Google Sheets: ' + err.message);
          });
      });
      
      document.body.appendChild(sheetsBtn);
      
      // Bot√£o para for√ßar verifica√ß√£o
      const forceBtn = document.createElement('button');
      forceBtn.innerHTML = 'üîÑ For√ßar Check';
      forceBtn.style.cssText = `
        position: fixed;
        bottom: 190px;
        left: 20px;
        background: #4285F4;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10000;
      `;
      
      forceBtn.addEventListener('click', () => {
        console.log('üîÑ For√ßando verifica√ß√£o...');
        localStorage.removeItem('sheets-last-check');
        if (window.verificarNotificacoesGoogleSheets) {
          navigator.serviceWorker.ready.then(reg => {
            verificarNotificacoesGoogleSheets(reg);
            alert('Verifica√ß√£o for√ßada iniciada!');
          });
        }
      });
      
      document.body.appendChild(forceBtn);
    }
  });
  </script>

  <!-- Script da Splash Screen Refinada -->
  <script src="/splash.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Economizei Rio Claro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f4c430">

  <!-- Splash -->
  <link rel="stylesheet" href="/splash.css">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff;
    }

    iframe {
      border: none;
      width: 100%;
      height: 100%;
      display: none;
      visibility: hidden;
      opacity: 0;
      transition: opacity .3s ease;
    }

    body.splash-complete iframe {
      display: block;
      visibility: visible;
      opacity: 1;
    }

    body:not(.splash-complete) > iframe {
      display: none !important;
    }

    /* ================= MODAL PUSH ================= */
    .push-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }

    .push-modal {
      background: #fff;
      width: 90%;
      max-width: 360px;
      border-radius: 18px;
      padding: 22px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
      animation: fadeUp .35s ease;
    }

    .push-actions {
      display: flex;
      gap: 10px;
    }

    .push-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .push-allow { background: #f4c430; }
    .push-deny  { background: #eee; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
  <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function () {
      OneSignal.init({
        appId: "fb033efd-5769-4c84-b550-0191fa5ff056",
        notifyButton: { enable: false },
        allowLocalhostAsSecureOrigin: true
      });
    });
  </script>
</head>

<body>

<!-- SPLASH -->
<div id="splash-screen">
  <div class="splash-container">
    <img src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png" width="200">
    <img src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/logo-texto.png" width="250">
  </div>
</div>

<!-- BLOG -->
<iframe src="https://www.economizeirioclaro.com.br/?app=1"></iframe>

<!-- MODAL PUSH -->
<div class="push-overlay" id="pushOverlay">
  <div class="push-modal">
    <h3>Receber notificações?</h3>
    <p>Ofertas e avisos em tempo real.</p>
    <div class="push-actions">
      <button class="push-deny" id="pushNo">Agora não</button>
      <button class="push-allow" id="pushYes">Ativar</button>
    </div>
  </div>
</div>

<script>
/* ================= MODAL ================= */
document.addEventListener('DOMContentLoaded', () => {

  const isPWA =
    matchMedia('(display-mode: standalone)').matches ||
    navigator.standalone;

  if (!isPWA) return;
  if (Notification.permission !== 'default') return;
  if (localStorage.getItem('push-modal-dismissed')) return;

  setTimeout(() => {
    pushOverlay.style.display = 'flex';
  }, 1500);

  pushNo.onclick = () => {
    localStorage.setItem('push-modal-dismissed', 'true');
    pushOverlay.remove();
  };

  pushYes.onclick = () => {
    OneSignal.push(() => OneSignal.showNativePrompt());
    localStorage.setItem('push-modal-dismissed', 'true');
    pushOverlay.remove();
  };
});
</script>

<script>
/* =====================================================
   GOOGLE SHEETS + ONESIGNAL (HÍBRIDO)
   ===================================================== */

const SHEETS_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQgRkzdvRw_Qjb_tMexnc49QXEAo4wdBAzA9spA_7PVQReYlH15GaVCTTjIBllU2IKZS0LEr-SBKk7b/pub?output=csv';

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}

setTimeout(verificarSheets, 3000);

async function verificarSheets() {
  const csv = await (await fetch(SHEETS_URL + '&t=' + Date.now())).text();
  const mensagens = csvToJson(csv);
  mensagens.forEach(enviarNotificacao);
}

function enviarNotificacao(msg) {
  const pushAtivo =
    window.OneSignal &&
    Notification.permission === 'granted';

  if (msg.push && pushAtivo) {
    enviarViaOneSignal(msg);
  } else {
    notificarLocal(msg);
  }
}

function enviarViaOneSignal(msg) {
  OneSignal.push(() => {
    OneSignal.sendSelfNotification(
      msg.titulo,
      msg.mensagem,
      msg.url
    );
  });
}

function notificarLocal(msg) {
  navigator.serviceWorker.ready.then(reg => {
    reg.active?.postMessage({
      type: 'SHOW_NOTIFICATION',
      title: msg.titulo,
      body: msg.mensagem,
      url: msg.url
    });
  });
}

function csvToJson(csv) {
  const linhas = csv.split('\n').slice(1);
  return linhas.map(l => {
    const c = l.split(',');
    return {
      titulo: c[1],
      mensagem: c[2],
      url: c[4],
      push: (c[6] || '').toLowerCase() === 'sim'
    };
  });
}
</script>

<script src="/splash.js"></script>
</body>
</html>

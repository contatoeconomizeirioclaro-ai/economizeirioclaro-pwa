<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Economizei Rio Claro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f4c430">
  
  <!-- CSS da Splash Screen Refinada -->
  <link rel="stylesheet" href="/splash.css">

  <style>
    /* Estilos principais do wrapper */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff;
    }
    
    /* Iframe - escondido inicialmente */
    iframe {
      border: none;
      width: 100%;
      height: 100%;
      display: none; /* Escondido at√© splash terminar */
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    /* Quando splash terminar, mostrar iframe */
    body.splash-complete iframe {
      display: block;
      visibility: visible;
      opacity: 1;
    }
    
    /* Estado inicial - garantir que tudo esteja escondido */
    body:not(.splash-complete) > iframe {
      display: none !important;
    }
    
    /* Bot√£o de Notifica√ß√µes (estilo) */
    #push-notification-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #f4c430;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(244, 196, 48, 0.3);
      transition: all 0.3s;
      font-size: 14px;
    }
    
    #push-notification-btn:hover {
      background: #e0b429;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(244, 196, 48, 0.4);
    }
    
    #push-notification-btn:active {
      transform: translateY(0);
    }
    
    /* Bot√£o para GitHub Notifications (se necess√°rio) */
    #github-notification-btn {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: #24292e;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      z-index: 10000;
      display: none;
    }
  </style>
</head>
<body>

  <!-- Splash Screen Refinada -->
  <!-- Aparece apenas no app instalado -->
  <div id="splash-screen">
    <div class="splash-container">
      <!-- PIN aumentado para 150px -->
      <img id="splash-pin" 
           src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png" 
           alt="√çcone Economizei"
           width="200"
           height="200">
      
      <!-- TEXTO mantido 250px -->
      <!-- Espa√ßo de 5px entre pin e texto -->
      <img id="splash-text" 
           src="https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/logo-texto.png" 
           alt="Economizei Rio Claro"
           width="250"
           height="90">
    </div>
  </div>

  <!-- Seu site Blogger no iframe -->
  <iframe
    src="https://www.economizeirioclaro.com.br/?app=1"
    loading="eager"
    referrerpolicy="no-referrer-when-downgrade"
    allow="fullscreen"
    title="Economizei Rio Claro - Ofertas e Promo√ß√µes">
  </iframe>

  <script>
  // ============================================
  // SISTEMA DE NOTIFICA√á√ïES ECONOMIZEI - VERS√ÉO EST√ÅVEL
  // ============================================

  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Economizei - Inicializando...');
    
    // ============================================
    // CONFIGURA√á√ïES DO SISTEMA
    // ============================================
    
    // CONFIG: Mudar para TRUE para ativar push notifications (precisa de backend)
    const USE_PUSH_NOTIFICATIONS = false; // Mantenha false para usar GitHub
    
    // CONFIG: Sistema de notifica√ß√µes via GitHub (RECOMENDADO)
    const GITHUB_NOTIFICATIONS = true;
    const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/notificacoes.json';
    const CHECK_INTERVAL_DAYS = 1; // Verificar a cada 1 dia
    
    // Registrar Service Worker apropriado
    if ('serviceWorker' in navigator) {
      const swToRegister = USE_PUSH_NOTIFICATIONS ? '/sw-push.js' : '/sw.js';
      
      navigator.serviceWorker.register(swToRegister)
        .then(registration => {
          console.log(`‚úÖ Service Worker registrado: ${swToRegister}`, registration.scope);
          
          // Inicializar sistemas de notifica√ß√£o
          if (USE_PUSH_NOTIFICATIONS) {
            initPushNotificationSystem(registration);
          }
          
          if (GITHUB_NOTIFICATIONS) {
            initGitHubNotificationSystem(registration);
          }
        })
        .catch(error => {
          console.error(`‚ùå Falha no Service Worker (${swToRegister}):`, error);
          
          // Fallback para sw.js se sw-push.js falhar
          if (USE_PUSH_NOTIFICATIONS && swToRegister === '/sw-push.js') {
            console.log('üîÑ Tentando fallback para sw.js...');
            navigator.serviceWorker.register('/sw.js')
              .then(fallbackReg => {
                console.log('‚úÖ Fallback sw.js registrado');
                if (GITHUB_NOTIFICATIONS) {
                  initGitHubNotificationSystem(fallbackReg);
                }
              })
              .catch(fallbackError => {
                console.error('‚ùå Fallback tamb√©m falhou:', fallbackError);
              });
          }
        });
    } else {
      console.log('‚ö†Ô∏è Navegador n√£o suporta Service Worker');
      // Tentar GitHub notifications mesmo sem service worker
      if (GITHUB_NOTIFICATIONS) {
        initGitHubNotificationSystem();
      }
    }
    
    // Verificar se est√° rodando como app instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('üì± Economizei rodando como app instalado');
      document.documentElement.setAttribute('data-app-mode', 'installed');
    }
    
    // ============================================
    // SISTEMA DE NOTIFICA√á√ïES VIA GITHUB (LOCAIS)
    // ============================================
    
    function initGitHubNotificationSystem(registration = null) {
      console.log('üêô Inicializando sistema GitHub Notifications...');
      
      // Verificar se j√° verificou hoje
      const ultimaVerificacao = localStorage.getItem('github-last-check');
      const hoje = new Date().toISOString().split('T')[0];
      
      if (ultimaVerificacao === hoje) {
        console.log('üìÖ J√° verificou notifica√ß√µes hoje');
        return;
      }
      
      // Esperar 5 segundos ap√≥s carregamento (melhor UX)
      setTimeout(async () => {
        try {
          await verificarNotificacoesGitHub(registration);
        } catch (erro) {
          console.error('‚ùå Erro no sistema GitHub:', erro);
        }
      }, 5000);
    }
    
    async function verificarNotificacoesGitHub(registration) {
      console.log('üîç Verificando notifica√ß√µes no GitHub...');
      
      try {
        // Buscar JSON do GitHub com cache-busting
        const resposta = await fetch(`${GITHUB_JSON_URL}?t=${Date.now()}`, {
          headers: { 'Cache-Control': 'no-cache' },
          mode: 'cors'
        });
        
        if (!resposta.ok) throw new Error(`HTTP ${resposta.status}`);
        
        const dados = await resposta.json();
        
        if (!dados.mensagens || !Array.isArray(dados.mensagens)) {
          throw new Error('Formato inv√°lido do JSON');
        }
        
        // Mensagens j√° vistas
        const mensagensVistas = JSON.parse(
          localStorage.getItem('github-mensagens-vistas') || '[]'
        );
        
        // Filtrar mensagens N√ÉO vistas
        const novasMensagens = dados.mensagens.filter(msg => 
          !mensagensVistas.includes(msg.id.toString())
        );
        
        console.log(`üìä ${novasMensagens.length} nova(s) mensagem(ns)`);
        
        if (novasMensagens.length > 0) {
          // Ordenar por prioridade
          const novasOrdenadas = ordenarPorPrioridade(novasMensagens);
          
          // Mostrar notifica√ß√µes
          mostrarNotificacoesEmSequencia(novasOrdenadas, registration);
          
          // Salvar como vistas
          salvarMensagensVistas(novasOrdenadas, mensagensVistas);
        }
        
        // Atualizar √∫ltima verifica√ß√£o
        localStorage.setItem('github-last-check', new Date().toISOString().split('T')[0]);
        
      } catch (erro) {
        console.error('‚ùå Erro ao verificar GitHub:', erro);
        // Tentar novamente em 1 hora se falhar
        setTimeout(() => {
          if (GITHUB_NOTIFICATIONS) {
            verificarNotificacoesGitHub(registration);
          }
        }, 3600000); // 1 hora
      }
    }
    
    function ordenarPorPrioridade(mensagens) {
      const prioridades = { alta: 3, media: 2, baixa: 1 };
      return [...mensagens].sort((a, b) => {
        return (prioridades[b.prioridade] || 1) - (prioridades[a.prioridade] || 1);
      });
    }
    
    function mostrarNotificacoesEmSequencia(mensagens, registration) {
      let delay = 0;
      
      mensagens.forEach((msg, index) => {
        // Espa√ßar as notifica√ß√µes (3 segundos entre elas)
        setTimeout(() => {
          mostrarNotificacaoLocal(msg, registration);
        }, delay);
        
        delay += 3000; // 3 segundos entre notifica√ß√µes
      });
    }
    
    function mostrarNotificacaoLocal(mensagem, registration) {
      // Verificar se temos permiss√£o para notifica√ß√µes
      if (!('Notification' in window)) {
        console.log('‚ö†Ô∏è Navegador n√£o suporta notifica√ß√µes');
        return;
      }
      
      const options = {
        body: mensagem.mensagem || 'Nova oferta dispon√≠vel!',
        icon: 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png',
        badge: 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png',
        tag: `economizei-github-${mensagem.id}`,
        data: {
          url: mensagem.url || 'https://www.economizeirioclaro.com.br',
          id: mensagem.id,
          source: 'github'
        },
        vibrate: [200, 100, 200],
        requireInteraction: mensagem.prioridade === 'alta'
      };
      
      // Tente usar service worker primeiro
      if (registration && 'showNotification' in registration) {
        registration.showNotification(mensagem.titulo || 'üì± Economizei', options)
          .catch(err => {
            console.log('‚ö†Ô∏è SW notification falhou, tentando fallback...', err);
            mostrarNotificacaoFallback(mensagem, options);
          });
      } else if (Notification.permission === 'granted') {
        // Fallback: notifica√ß√£o do navegador
        mostrarNotificacaoFallback(mensagem, options);
      } else if (Notification.permission === 'default') {
        // Solicitar permiss√£o silenciosamente
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            mostrarNotificacaoFallback(mensagem, options);
          }
        });
      }
    }
    
    function mostrarNotificacaoFallback(mensagem, options) {
      try {
        const notificacao = new Notification(
          mensagem.titulo || 'üì± Economizei', 
          options
        );
        
        notificacao.onclick = () => {
          window.open(
            mensagem.url || 'https://www.economizeirioclaro.com.br', 
            '_blank'
          );
          notificacao.close();
        };
        
        notificacao.onclose = () => {
          console.log('üì™ Notifica√ß√£o fechada:', mensagem.id);
        };
      } catch (err) {
        console.error('‚ùå Erro ao criar notifica√ß√£o:', err);
      }
    }
    
    function salvarMensagensVistas(novasMensagens, mensagensVistasAnteriores) {
      const novosIds = novasMensagens.map(msg => msg.id.toString());
      const todasVistas = [...mensagensVistasAnteriores, ...novosIds];
      
      // Manter apenas √∫ltimas 50 mensagens (evitar armazenamento excessivo)
      const limitadas = todasVistas.slice(-50);
      
      localStorage.setItem('github-mensagens-vistas', JSON.stringify(limitadas));
    }
    
    // ============================================
    // SISTEMA DE PUSH NOTIFICATIONS (OPCIONAL)
    // ============================================
    
    function initPushNotificationSystem(registration) {
      console.log('üîî Inicializando sistema de push notifications...');
      
      // Criar bot√£o de ativa√ß√£o
      const notificationBtn = document.createElement('button');
      notificationBtn.id = 'push-notification-btn';
      notificationBtn.innerHTML = 'üîî Ativar Notifica√ß√µes Push';
      
      // Estado inicial
      const isAlreadyEnabled = localStorage.getItem('economizei-push-enabled') === 'true';
      const permissionStatus = Notification.permission;
      
      console.log('üìä Status Push:', {
        enabled: isAlreadyEnabled,
        permission: permissionStatus
      });
      
      // Mostrar bot√£o apenas se:
      // 1. N√£o est√° j√° ativado
      // 2. Permiss√£o n√£o foi negada
      // 3. Permiss√£o n√£o foi concedida ainda
      if (!isAlreadyEnabled && permissionStatus === 'default') {
        notificationBtn.style.display = 'block';
      } else {
        notificationBtn.style.display = 'none';
        
        if (permissionStatus === 'granted') {
          console.log('‚úÖ Push notifications j√° ativadas');
        } else if (permissionStatus === 'denied') {
          console.log('‚ùå Permiss√£o para push foi negada');
        }
      }
      
      // Evento de clique no bot√£o
      notificationBtn.addEventListener('click', async function() {
        console.log('üñ±Ô∏è Bot√£o de push clicado');
        
        try {
          notificationBtn.innerHTML = '‚è≥ Solicitando permiss√£o...';
          notificationBtn.disabled = true;
          
          const permission = await Notification.requestPermission();
          console.log('üîì Resultado da permiss√£o:', permission);
          
          if (permission === 'granted') {
            try {
              // Chave p√∫blica VAPID de teste
              const vapidPublicKey = 'BKYvJLwQ9gQcKJvK7vL8cT7HJkLp09gFcVbN7mKjL9hTqW8zXcVbN7mKjL9hTqW8zXc';
              
              const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
              });
              
              localStorage.setItem('economizei-push-enabled', 'true');
              localStorage.setItem('economizei-push-subscription', JSON.stringify(subscription));
              
              notificationBtn.innerHTML = '‚úÖ Push Ativadas!';
              notificationBtn.style.background = '#4CAF50';
              
              console.log('üéâ Inscri√ß√£o push bem-sucedida');
              
              setTimeout(() => {
                notificationBtn.style.display = 'none';
              }, 2000);
              
            } catch (subscribeError) {
              console.error('‚ùå Erro na inscri√ß√£o push:', subscribeError);
              
              localStorage.setItem('economizei-push-enabled', 'true');
              
              notificationBtn.innerHTML = '‚úÖ Notifica√ß√µes Locais';
              notificationBtn.style.background = '#4CAF50';
              
              setTimeout(() => {
                notificationBtn.style.display = 'none';
              }, 2000);
            }
            
          } else if (permission === 'denied') {
            notificationBtn.innerHTML = '‚ùå Permiss√£o Negada';
            notificationBtn.style.background = '#f44336';
            
            setTimeout(() => {
              notificationBtn.innerHTML = 'üîî Ativar Push';
              notificationBtn.style.background = '#f4c430';
              notificationBtn.disabled = false;
            }, 3000);
            
          } else {
            notificationBtn.innerHTML = 'üîî Ativar Push';
            notificationBtn.disabled = false;
          }
          
        } catch (error) {
          console.error('üí• Erro no processo de ativa√ß√£o:', error);
          
          notificationBtn.innerHTML = '‚ùå Erro - Tente Novamente';
          notificationBtn.style.background = '#f44336';
          
          setTimeout(() => {
            notificationBtn.innerHTML = 'üîî Ativar Push';
            notificationBtn.style.background = '#f4c430';
            notificationBtn.disabled = false;
          }, 3000);
        }
      });
      
      // Adicionar bot√£o ao body
      document.body.appendChild(notificationBtn);
      
      // Fun√ß√£o auxiliar para converter chave VAPID
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');
        
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }
    }
    
    // ============================================
    // TESTE MANUAL DE NOTIFICA√á√ÉO (para desenvolvimento)
    // ============================================
    
    // Adicionar bot√£o de teste se estiver em desenvolvimento
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
      const testBtn = document.createElement('button');
      testBtn.innerHTML = 'üîß Testar Notifica√ß√£o';
      testBtn.style.cssText = `
        position: fixed;
        bottom: 70px;
        left: 20px;
        background: #9C27B0;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10000;
      `;
      
      testBtn.addEventListener('click', () => {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.ready.then(reg => {
            reg.showNotification('üì± Economizei - Teste', {
              body: 'Esta √© uma notifica√ß√£o de teste do GitHub system!',
              icon: 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png',
              badge: 'https://raw.githubusercontent.com/contatoeconomizeirioclaro-ai/economizeirioclaro-pwa/main/assets/pin.png',
              vibrate: [200, 100, 200],
              data: {
                url: 'https://www.economizeirioclaro.com.br',
                test: true,
                source: 'test'
              }
            });
          });
        }
      });
      
      document.body.appendChild(testBtn);
      
      // Bot√£o para limpar cache de notifica√ß√µes
      const clearBtn = document.createElement('button');
      clearBtn.innerHTML = 'üîÑ Limpar Cache';
      clearBtn.style.cssText = `
        position: fixed;
        bottom: 110px;
        left: 20px;
        background: #FF9800;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10000;
      `;
      
      clearBtn.addEventListener('click', () => {
        localStorage.removeItem('github-last-check');
        localStorage.removeItem('github-mensagens-vistas');
        console.log('üóëÔ∏è Cache de notifica√ß√µes limpo!');
        alert('Cache limpo. Notifica√ß√µes ser√£o verificadas novamente.');
      });
      
      document.body.appendChild(clearBtn);
    }
  });
  </script>

  <!-- Script da Splash Screen Refinada -->
  <script src="/splash.js"></script>

</body>
</html>
